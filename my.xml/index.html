<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<script type="text/javascript" src="js/jquery-1.8.0.js"></script>
<style type="text/css">
    body {
        background-color: #333;
        color: #fff;
        font-size: 0.8em;
    }

    #draw-target {
        width: 100%;
        height: 100%;
        background-color: #ccf;
        position: relative;
    }

    #draw-target div {
        vertical-align: bottom;
        /* line-height: 10; */
        background-repeat: no-repeat;
    }
</style>
<body>
    <div id="draw-target">

    </div>
</body>
</html>
<script type="text/javascript">

    var positonContena = [
        //{x: 0, y:0}
    ];

    var DHTMLSprite = function (params) {

        var exist = false;
        $(positonContena).each(function(index, data) {
            if (params.x == data.x && params.y == data.y) {
                console.log("obj already exist!!");
                exist = true;
            }
        });

        if (exist) {
            return null;
        }
        if (!positonContena.length || !exist) {
            positonContena.push({
                x:params.x,
                y:params.y
            });
        }

        //console.log(positonContena);

        var imagesWidth = params.imagesWidth,
            $element = params.$drawTarget.append('<div/>').find(':last').append('<img src="' + params.image + '"><div>' + params.itemName + '</div>'),
            elemStyle = $element[0].style,
// 高速化のためMath.floorのローカル参照を持つ
                mathFloor = Math.floor;

        elemStyle.left = params.x + 'px';
        elemStyle.top = params.y + 'px';

        $element.css({
            position:'absolute'
            //width:width,
            //height:height,
            //backgroundImage:'url(' + params.image + ')'
        });
        var that = {
            draw:function (x, y) {


                var exist = false;
                $(positonContena).each(function(index, data) {
                    if (x == data.x && y == data.y) {
                        console.log("obj already exist!!");
                        exist = true;
                    }
                });

                if (!positonContena.length || !exist) {
                    positonContena.push({
                        x:x,
                        y:y
                    });
                }

                elemStyle.left = x + 'px';
                elemStyle.top = y + 'px';
            },
//            changeImage:function (index) {
//                index *= width;
//                var vOffset = -mathFloor(index / imagesWidth) * height;
//                var hOffset = -index % imagesWidth;
//                elemStyle.backgroundPosition = hOffset + 'px ' + vOffset + 'px';
//                console.log(elemStyle.backgroundPosition);
//            },
            show:function () {
                elemStyle.display = 'block';
            },
            hide:function () {
                elemStyle.display = 'none';
            },
            destroy:function () {
                $element.remove();
            }
        };

        console.log('children');
        var children = params.children || null;
        if (children && children.length) {
        console.log(children[0]);
        $element.click(function() {

            $(children[0]).children().each(function(index, item) {
//               console.log(item);
//            });
//
//
//
//            var items = $(children[0]).find('children > item');
//            console.log(items);
//            $(items).each(function(index, item) {
                console.log("^^^^^^^^^^^^");
                console.log(item);
                var itemName = $(item).find('itemName')[0].textContent;
                var image = $(item).find('image')[0].textContent;
                var x = $(item).find('x')[0].textContent;
                var y = $(item).find('y')[0].textContent;

                var children = $(item).find('children');
                var params = {
                    itemName : itemName,
                    image: image,
                    imagesWidth: 0,
                    x: x,
                    y: y,
                    children: children,
                    $drawTarget:$('#draw-target')
                }
                var sprite = DHTMLSprite(params);
            });
        });

        }

// DHTMLSpriteのインスタンスを返す
        return that;
    };
    $(document).ready(function () {
        console.log("start!!");

        $.ajax({
            type:'GET',
            url:'data/control.xml',
            dataType:'xml',
            success:function (xml) {
                parseXml(xml);
            }
        });
    });

    var parseXml = function (xml) {

        var baseItem = $(xml).find('root > BaseItem');
        var baseSprite = DHTMLSprite({
            itemName: "",
            image: $(baseItem).find('image')[0].textContent,
            $drawTarget:$('#draw-target')
        });
        baseSprite.draw($(baseItem).find('x')[0].textContent, $(baseItem).find('y')[0].textContent);

        var items = $(xml).find('root > item');
        $(items).each(function (index, item) {
            var itemName = $(item).find('itemName')[0].textContent;
            var image = $(item).find('image')[0].textContent;
            var x = $(item).find('x')[0].textContent;
            var y = $(item).find('y')[0].textContent;

            var children = $(item).find('item > children');
            var params = {
                itemName : itemName,
                image: image,
                imagesWidth: 0,
                x: x,
                y: y,
                children: children,
                $drawTarget:$('#draw-target')
            }
            var sprite = DHTMLSprite(params);
            //sprite.draw(x, y);

            //console.log($(item).find('children > item'));
        })
    };
</script>


