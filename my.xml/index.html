<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<script type="text/javascript"
        src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<link rel="stylesheet" href="css/style.css">
<body>
<style type="text/css">
    div#draw-target {
        /* top: 350px;
        left: 350px;
        position: absolute; */
    }
</style>
<div id="draw-target">

</div>
</body>
</html>
<script type="text/javascript">

    var positonContena = [];

    var centerPoint = {
        top: 0,
        left: 0
    };

    $(document).ready(function () {
        $.ajax({
            type:'GET',
            url:'data/control.xml',
            dataType:'xml',
            success:function (xml) {
                parseXml(xml);
            }
        });
    });

    var DHTMLSprite = function (params) {
        // itemが既に存在しているかどうかチェックする
        if (checkItemExist(positonContena, params.x, params.y)) {
            return null;
        }
        if (!positonContena.length) {
            positonContena.push({
                x:params.x,
                y:params.y
            });
        }

        var $element = params.$drawTarget.append('<div/>').find(':last').append('<img src="' + params.image + '"><div>' + params.itemName + '</div>'),
            elemStyle = $element[0].style;

        elemStyle.left = params.x + 'px';
        elemStyle.top = params.y + 'px';

        $element.css({
            position:'absolute'
        });
        var that = {
            draw:function (x, y) {
                elemStyle.left = x + 'px';
                elemStyle.top = y + 'px';
            },
            show:function () {
                elemStyle.display = 'block';
            },
            hide:function () {
                elemStyle.display = 'none';
            },
            destroy:function () {
                $element.remove();
            }
        };

        var children = params.children || null;
        if (children && children.length) {
            $element.click(function () {
                var top = elemStyle.top;
                top = Number(top.replace("px", ""));

                var left = elemStyle.left;
                left = Number(left.replace("px", ""));

                var moveDistance = {
                    top: top - centerPoint.top,
                    left: left - centerPoint.left
                };

                console.log("top : " + moveDistance.top);
                console.log("left : " + moveDistance.left);

        $( "#draw-target" ).animate({
            //left: moveDistance.left
            left: -moveDistance.left,
            top: -moveDistance.top
        }, {
            duration: 1000,
            step: function( now, fx ){
                //console.log(now);
                $( "#draw-target" ).css( "left", now );
                $( "#draw-target" ).css( "top", now );
            }
        });
                //$('#draw-target').animate({ left: left });
                //$('html, body').animate({ scrollLeft: left });


                $(children[0]).children().each(function (index, item) {
                    var sprite = makeChildItemFromParent(item);
                });
            });
        }
        return that;
    };

    var parseXml = function (xml) {
        // ルートItemの表示処理
        var baseItem = $(xml).find('root > BaseItem');
        var baseSprite = DHTMLSprite({
            itemName:"",
            image:$(baseItem).find('image')[0].textContent,
            $drawTarget:$('#draw-target')
        });
        var x = $(baseItem).find('x')[0].textContent;
        var y = $(baseItem).find('y')[0].textContent;

        baseSprite.draw(x, y);

        centerPoint = {top: y, left: x};

        // ルートItem周りのItem表示処理
        var items = $(xml).find('root > item');
        $(items).each(function (index, item) {
            var sprite = makeChildItemFromParent(item);
        });
    };

    var makeChildItemFromParent = function(item) {
        var itemName = $(item).find('itemName')[0].textContent;
        var image = $(item).find('image')[0].textContent;
        var x = $(item).find('x')[0].textContent;
        var y = $(item).find('y')[0].textContent;

        var children = $(item).find('children');
        var params = {
            itemName:itemName,
            image:image,
            x:x,
            y:y,
            children:children,
            $drawTarget:$('#draw-target')
        }
        return DHTMLSprite(params);
    };

    var checkItemExist = function (array, x, y) {
        var exist = false;
        $(array).each(function (index, data) {
            if (x == data.x && y == data.y) {
                exist = true;
            }
        });
        return exist;
    };
</script>
<script>

    //$('html, body').scrollTop(500);
    $('html, body').animate({ scrollTop: 1000 });
    //$('#draw-target').animate({ left: 100 });
//
//    $( "#go" ).click(function(){
//        $('#draw-target').animate({ top: 300 });
//        $( "#draw-target" ).animate({
//            left: 100,
//            bottom:200
//        }, {
//            duration: 1000,
//            step: function( now, fx ){
//                console.log(now);
//                $( "#draw-target" ).css( "left", now );
//            }
//        });
//    });
</script>

