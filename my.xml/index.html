<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<script type="text/javascript"
        src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<!--<script type="text/javascript" src="js/jquery-1.8.0.js"></script>-->
<script type="text/javascript" src="js/jquery.svg.js"></script>
<link rel="stylesheet" href="css/style.css">
<style type="text/css">
    div#canv-target {
        position: absolute;
        left: -2000px;
        top: -2000px;
        width: 5000px;
        height: 5000px;
    }

    div#overall-container {
        border:1px solid #777777;
        width:1000px;
        height:600px;
        top:0px;
        left:0px;
        position:absolute;
        z-index: 400;
        background-color: #333;
    }
</style>
<body>
<div id="overall-container">
    <div style="z-index: 300; position: absolute; border-width: 0px; overflow: hidden; width: 1000px; height: 600px; ">
        <div style="z-index: 300; position: absolute; top: 0px; left: 0px; " id="left-top-point">
            <div id="draw-target" style="z-index: 100">
                <div id="canv-target"></div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
<script type="text/javascript">

    var positonContena = [];

    var centerPoint = {
        top: 0,
        left: 0
    };

    $("#canv-target").svg();
    var svg = $('#canv-target').svg('get');

    $(document).ready(function () {

        $.ajax({
            type:'GET',
            url:'data/control.xml',
            dataType:'xml',
            success:function (xml) {
                parseXml(xml);
            }
        });
    });

    var DHTMLSprite = function (params) {
        // itemが既に存在しているかどうかチェックする
        if (checkItemExist(positonContena, params.x, params.y)) {
            return null;
        }
        if (!positonContena.length) {
            positonContena.push({
                x:params.x,
                y:params.y
            });
        }

        var itemName = params.itemName.replace('\n', '<br>'); // TODO 改行処理
        var $element = params.$drawTarget.append('<div/>').find(':last').append('<img src="' + params.image + '"><div>' + itemName + '</div>'),
            elemStyle = $element[0].style;

        elemStyle.left = params.x + 'px';
        elemStyle.top = params.y + 'px';

        $element.css({
            position:'absolute'
        });

        var lineContainer = [];

        var that = {
            draw:function (x, y) {
                elemStyle.left = x + 'px';
                elemStyle.top = y + 'px';
            },
            show:function () {
                elemStyle.display = 'block';
                if (lineContainer.length) {
                    $(lineContainer).each(function(index, line) {
                        $(line).css({
                            "display" : "block"
                        })
                    });
                }
            },
            hide:function () {
                elemStyle.display = 'none';
                if (lineContainer.length) {
                    $(lineContainer).each(function(index, line) {
                        $(line).css({
                            "display" : "none"
                        })
                    });
                }
            },
            destroy:function () {
                $element.remove();
            },
            getElement:function() {
                return $element;
            },
            getElemStyle:function() {
                return elemStyle;
            },
            drawLine:function(origX, origY) {
                var destX = elemStyle.left;
                destX = destX.replace("px", "");
                var destY = elemStyle.top;
                destY = destY.replace("px", "");
                var line = drawSVGLine(origX, origY, destX, destY);
                lineContainer.push(line);
            }
        };

        var url = params.url;
        if (url) {
            $element.click(function() {
                window.open(url);
                return false;
            });
        }

        var children = params.children || null;
        if (children && children.length) {
            $element.click(function () {
                var top = elemStyle.top;
                top = Number(top.replace("px", ""));
                var left = elemStyle.left;
                left = Number(left.replace("px", ""));
                var moveDistance = {
                    top: top - centerPoint.top,
                    left: left - centerPoint.left
                };
                $("#left-top-point").animate({
                    left: -moveDistance.left,
                    top: -moveDistance.top

                });

                var childItem = $.data($element, "childItem");
                var childVisible = $.data($element, "childVisible");
                if (childItem) {
                    if (childVisible) {
                        $(childItem).each(function(index, item) {
                            makeChildItemInvisible(item);
                        });
                        $.data($element, "childVisible", false);
                    }
                    else {
                        $(childItem).each(function(index, item) {
                            item.show();
                        });
                        $.data($element, "childVisible", true);
                    }
                    return;
                }

                var childContainer = [];
                $(children[0]).children().each(function (index, item) {
                    var sprite = makeChildItemFromParent(item);
                    sprite.drawLine(left, top);
                    childContainer.push(sprite);
                });
                $.data($element, "childItem", childContainer);
                $.data($element, "childVisible", true);
            });
        }
        return that;
    };

    var makeChildItemInvisible = function(item) {
        // item内のelementを取得
        var cElem = item.getElement();
        var cItem = $.data(cElem, "childItem");
        var cVisible = $.data(cElem, "childVisible");
        if (cVisible) {
            if (cItem) {
                $(cItem).each(function(idx, itm) {
                    makeChildItemInvisible(itm);
                    itm.hide();
                });
            }
            $.data(cElem, "childVisible", false);
        }
        item.hide();
    };

    var parseXml = function (xml) {
        // ルートItemの表示処理
        var baseItem = $(xml).find('root > BaseItem');
        var baseSprite = DHTMLSprite({
            itemName:"",
            image:$(baseItem).find('image')[0].textContent,
            $drawTarget:$('#draw-target')
        });
        var x = $(baseItem).find('x')[0].textContent;
        var y = $(baseItem).find('y')[0].textContent;

        baseSprite.draw(x, y);

        centerPoint = {top: y, left: x};

        // ルートItem周りのItem表示処理
        var items = $(xml).find('root > item');
        $(items).each(function (index, item) {
            var sprite = makeChildItemFromParent(item);

//            var beginX = Number(centerPoint.left) + 50;
//            var beginY = Number(centerPoint.top) + 70;
            var beginX = Number(centerPoint.left) + 20;
            var beginY = Number(centerPoint.top) + 40;
            var elemStyle = sprite.getElemStyle();
            var destX = elemStyle.left;
            destX = destX.replace("px", "");
            var destY = elemStyle.top;
            destY = destY.replace("px", "");
            drawSVGLine(beginX, beginY, destX, destY);
        });
    };

    var makeChildItemFromParent = function(item) {
        var itemName = $(item).find('itemName')[0].textContent;
        var image = $(item).find('image')[0].textContent;
        var x = $(item).find('x')[0].textContent;
        var y = $(item).find('y')[0].textContent;
        var url = $(item).find('url');
        var ite = $(item).find('item');
        if (!ite.length && url.length) {
            url = $(item).find('url')[0].textContent;
            console.log(url);
        }
        else {
            url = null;
        }

        var children = $(item).find('children');
        var params = {
            itemName: itemName,
            image: image,
            x: x,
            y: y,
            children: children,
            url: url,
            $drawTarget:$('#draw-target')
        }
        return DHTMLSprite(params);
    };

    var checkItemExist = function (array, x, y) {
        var exist = false;
        $(array).each(function (index, data) {
            if (x == data.x && y == data.y) {
                exist = true;
            }
        });
        return exist;
    };

    var drawSVGLine = function(beginX, beginY, endX, endY) {

        var margin = 2000;

        beginX = Number(beginX) + margin + 30;
        beginY = Number(beginY) + margin + 30;
        endX = Number(endX) + margin + 30;
        endY = Number(endY) + margin + 30;

        var line = svg.line(beginX, beginY, endX, endY, {stroke: '#999999', strokeWidth: 0.3});
        return line;
    }
</script>
